
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tome of the Codex — Phase III</title>
<style>
  :root{
    --bg:#0b0f14; --ink:#cfe6ff; --accent:#7fb1ff; --gold:#ffd97a; --violet:#b08cff; --muted:#94a8be;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 900px at 50% 55%, #0f151c 0%, var(--bg) 60%, #06090d 100%);color:#d7e6f8;font-family:Inter,Segoe UI,system-ui,Arial,sans-serif}
  .layout{display:grid;grid-template-columns: 320px 1fr;grid-template-rows:auto 1fr;gap:14px;max-width:1280px;margin:20px auto;padding:12px}
  header{grid-column:1/-1;background:linear-gradient(180deg,#0e1620,#0c1219);border:1px solid #1b2834;border-radius:16px;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 18px 60px rgba(0,0,0,.45), inset 0 0 80px rgba(0,0,0,.25)}
  h1{font-size:18px;letter-spacing:.8px;margin:0;color:#e6f2ff}
  .badge{font-size:12px;color:#9fb8d3;opacity:.9}
  .left{background:linear-gradient(#0e151c,#0c1218);border:1px solid #1b2834;border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:12px}
  .section{border:1px solid #1f2c39;border-radius:14px;padding:10px 10px 12px;background:radial-gradient(600px 220px at 50% -10%, rgba(160,200,255,.06), transparent), #0c1218}
  .section h3{margin:0 0 8px;font-size:13px;letter-spacing:.5px;color:#d9e7fb}
  .chapters button{width:100%;margin:5px 0;padding:10px 10px;border-radius:10px;border:1px solid #243244;background:#0f1721;color:#cfe2fb;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:space-between}
  .chapters button:hover{border-color:#2b3b4d;background:#121b26}
  .chapters button.active{outline:2px solid #34506d; background:#122033}
  .swatch{width:14px;height:14px;border-radius:50%;border:1px solid #314559}
  .swatch.blue{background:#9dd0ff}.swatch.violet{background:#b08cff}.swatch.gold{background:#ffd97a}.swatch.shadow{background:#556170}
  .controls label{display:block;font-size:12px;color:#a9bed6;margin:10px 0 4px}
  .controls input[type=range]{width:100%}
  .controls .row{display:flex;gap:8px}.controls .row > *{flex:1}
  .btn{padding:9px 11px;border-radius:10px;border:1px solid #2b3b4d;background:#101a25;color:#cfe2fb;cursor:pointer}
  .btn:hover{background:#132132}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#0c1520;border:1px solid #2a3b4f;border-radius:6px;padding:2px 6px;font-size:12px;color:#bcd2ea}
  .canvas{background:linear-gradient(#0e141a,#0a1015);border:1px solid #1b2834;border-radius:16px;padding:0;position:relative;overflow:hidden}
  .toolbar{position:absolute;inset:12px 12px auto auto;display:flex;gap:8px;z-index:3}
  .toolbar .btn{font-size:12px;padding:7px 10px}
  .hint{position:absolute;inset:auto 14px 14px 14px;opacity:.75;font-size:12px;color:#a6bacf;line-height:1.4;z-index:1}
  svg{display:block;width:100%;height:100%;filter: drop-shadow(0 0 5px rgba(140,180,255,.35))}
  .grain, .grain::before{position:absolute;inset:-50%}
  .grain{opacity:.10;mix-blend-mode:soft-light;pointer-events:none}
  .grain::before{content:""; background-image:url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width=\"400\" height=\"400\">\
<filter id=\"n\"><feTurbulence type=\"fractalNoise\" baseFrequency=\"0.95\" numOctaves=\"2\"/></filter>\
<rect width=\"100%\" height=\"100%\" filter=\"url(%23n)\" opacity=\"0.8\"/></svg>');animation: move 22s linear infinite;}
  @keyframes move{from{transform:translate3d(0,0,0) scale(2)} to{transform:translate3d(-25%,-25%,0) scale(2)}}

  /* Brush overlay */
  #brushLayer{position:absolute;inset:0;pointer-events:none; z-index:2;}
  .floating-tooltip{position:absolute;background:#0b1420;border:1px solid #203246;border-radius:8px;padding:6px 8px;font-size:12px;color:#cfe2fb;opacity:.9;z-index:4}
</style>
</head>
<body>
<div class="layout">
  <header>
    <div>
      <h1>Tome of the Codex — Phase III</h1>
      <div class="badge">MIDI • Mic • Runic Brush • Timeline</div>
    </div>
    <div>
      <button class="btn" id="exportBtn">Export PNG</button>
      <button class="btn" id="recordBtn">Record WebM</button>
      <a id="downloadLink" style="display:none;margin-left:8px" class="btn" download="codex_recording.webm">Download</a>
    </div>
  </header>

  <aside class="left">
    <div class="section chapters">
      <h3>Chapters</h3>
      <button data-chapter="awakening"><span>Awakening</span><span class="swatch blue"></span></button>
      <button data-chapter="transformation"><span>Transformation</span><span class="swatch violet"></span></button>
      <button data-chapter="realization"><span>Realization</span><span class="swatch gold"></span></button>
      <button data-chapter="shadow"><span>Shadow</span><span class="swatch shadow"></span></button>
    </div>

    <div class="section controls">
      <h3>Sigil Controls</h3>
      <label>Rune Count</label>
      <input id="runeCount" type="range" min="6" max="48" value="22">
      <div class="row">
        <div>
          <label>Entropy (shape variance)</label>
          <input id="entropy" type="range" min="0" max="100" value="45">
        </div>
        <div>
          <label>Pulse Speed</label>
          <input id="speed" type="range" min="5" max="240" value="100">
        </div>
      </div>
      <div class="row">
        <button class="btn" id="newSigil">Generate Sigil</button>
        <button class="btn" id="saveEntry">Save Entry</button>
      </div>
      <div style="font-size:12px;color:#a9bed6;margin-top:8px">
        <b>Shortcuts</b> — <span class="kbd">Space</span> Play/Pause, <span class="kbd">L</span> Links, <span class="kbd">G</span> Glow, <span class="kbd">N</span> New, <span class="kbd">S</span> Save, <span class="kbd">1-4</span> Chapters
      </div>
    </div>

    <div class="section">
      <h3>Auto-Compose & Reactivity</h3>
      <div class="row">
        <button class="btn" id="autoToggle">Start</button>
        <button class="btn" id="autoNow">Compose Now</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="midiBtn">Enable MIDI</button>
        <button class="btn" id="micBtn">Enable Mic</button>
      </div>
      <div style="font-size:12px;color:#a9bed6;margin-top:6px">
        MIDI velocity & mic amplitude modulate pulses and link intensity.
      </div>
    </div>

    <div class="section">
      <h3>Create Mode — Runic Brush</h3>
      <div class="row">
        <button class="btn" id="createToggle">Create: Off</button>
        <button class="btn" id="undoBtn">Undo</button>
        <button class="btn" id="redoBtn">Redo</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="rotateBtn">Rotate</button>
        <button class="btn" id="scaleBtn">Scale</button>
        <button class="btn" id="fuseBtn">Fuse</button>
      </div>
      <div style="font-size:12px;color:#a9bed6;margin-top:6px">
        Click/drag on the canvas to place runes. Ctrl+Z undo, Ctrl+Y redo, Ctrl+S save entry.
      </div>
    </div>

    <div class="section">
      <h3>Timeline</h3>
      <div class="row">
        <button class="btn" id="recToggle">Record Session</button>
        <button class="btn" id="replayBtn">Replay</button>
        <button class="btn" id="clearLog">Clear</button>
      </div>
      <div id="timelineInfo" style="font-size:12px;color:#a9bed6;margin-top:6px">Frames: 0</div>
    </div>

    <div class="section">
      <h3>Saved Entries</h3>
      <div id="entriesList" style="display:flex;flex-direction:column;gap:8px;max-height:220px;overflow:auto;"></div>
    </div>
  </aside>

  <main class="canvas" tabindex="0" id="canvasFocus">
    <div class="toolbar">
      <button class="btn" id="playPause">Pause</button>
      <button class="btn" id="centerGlow">Center Glow</button>
      <button class="btn" id="linksToggle">Links</button>
      <button class="btn" id="soundToggle">Sound: Off</button>
    </div>
    <svg id="codex" viewBox="0 0 1000 1000" preserveAspectRatio="xMidYMid meet" aria-label="Interactive Codex Canvas">
      <defs>
        <radialGradient id="coreGlow" cx="50%" cy="50%" r="50%">
          <stop offset="0%" stop-color="#c2e5ff" stop-opacity="1"/>
          <stop offset="55%" stop-color="#87bfff" stop-opacity=".55"/>
          <stop offset="100%" stop-color="#5c89ff" stop-opacity="0"/>
        </radialGradient>
        <filter id="soft" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="6" result="b"/>
          <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>
      <circle cx="500" cy="500" r="435" fill="none" stroke="#1b2834" stroke-width="22"/>
      <circle id="coreBg" cx="500" cy="500" r="420" fill="url(#coreGlow)" opacity=".14"/>
      <g id="rings" stroke="#9cc9ff" stroke-width="2" opacity=".55">
        <circle cx="500" cy="500" r="360"/><circle cx="500" cy="500" r="275"/><circle cx="500" cy="500" r="190"/>
      </g>
      <g id="tri" fill="none" stroke="#bfe4ff" stroke-width="10" stroke-linecap="round" filter="url(#soft)">
        <path d="M500 260 C 540 330, 540 380, 500 440 C 460 380, 460 330, 500 260 Z"/>
        <path d="M430 335 C 470 405, 470 455, 430 515 C 390 455, 390 405, 430 335 Z"/>
        <path d="M570 335 C 610 405, 610 455, 570 515 C 530 455, 530 405, 570 335 Z"/>
      </g>
      <g id="runes" stroke-linecap="round" stroke-linejoin="round" fill="none"></g>
      <g id="links" stroke="#7fb1ff" stroke-width="2" opacity=".75"></g>
      <!-- Brush Overlay (SVG layer for placed runes) -->
      <g id="brush" stroke-linecap="round" stroke-linejoin="round" fill="none"></g>
    </svg>

    <canvas id="brushLayer"></canvas>
    <div class="grain"></div>
    <div class="hint">
      Phase III: MIDI/Mic reactivity, Runic Brush (Create mode), Timeline record/replay, and WebM recording.
    </div>
    <div id="tooltip" class="floating-tooltip" style="display:none">Create Mode: click/drag to place runes</div>
  </main>
</div>

<script>
(function(){
  const CX=500, CY=500;
  const svg = document.getElementById('codex');
  const gRunes = document.getElementById('runes');
  const gLinks = document.getElementById('links');
  const gBrush = document.getElementById('brush');
  const tri = document.getElementById('tri');
  const coreBg = document.getElementById('coreBg');
  const canvasFocus = document.getElementById('canvasFocus');
  const brushLayer = document.getElementById('brushLayer');
  const tooltip = document.getElementById('tooltip');

  const chapterBtns = [...document.querySelectorAll('[data-chapter]')];
  const runeCountEl = document.getElementById('runeCount');
  const entropyEl = document.getElementById('entropy');
  const speedEl = document.getElementById('speed');
  const newSigilBtn = document.getElementById('newSigil');
  const saveBtn = document.getElementById('saveEntry');
  const entriesList = document.getElementById('entriesList');
  const playPauseBtn = document.getElementById('playPause');
  const linksToggleBtn = document.getElementById('linksToggle');
  const centerGlowBtn = document.getElementById('centerGlow');
  const exportBtn = document.getElementById('exportBtn');
  const autoToggleBtn = document.getElementById('autoToggle');
  const autoNowBtn = document.getElementById('autoNow');
  const soundToggleBtn = document.getElementById('soundToggle');
  const midiBtn = document.getElementById('midiBtn');
  const micBtn = document.getElementById('micBtn');
  const recordBtn = document.getElementById('recordBtn');
  const downloadLink = document.getElementById('downloadLink');

  const createToggleBtn = document.getElementById('createToggle');
  const undoBtn = document.getElementById('undoBtn');
  const redoBtn = document.getElementById('redoBtn');
  const rotateBtn = document.getElementById('rotateBtn');
  const scaleBtn = document.getElementById('scaleBtn');
  const fuseBtn = document.getElementById('fuseBtn');

  const recToggle = document.getElementById('recToggle');
  const replayBtn = document.getElementById('replayBtn');
  const clearLog = document.getElementById('clearLog');
  const timelineInfo = document.getElementById('timelineInfo');

  let playing = true, showLinks=true, centerGlow=true, chapter='awakening';
  let autoCompose=false, nextComposeAt=0;
  let audioCtx=null, masterGain=null, ambient=null, chime=null, audioOn=false;
  let midiEnabled=false, micEnabled=false, micAnalyser=null, micData=null;
  let recorder=null, recording=false, recordChunks=[];
  let createMode=false, brushStack=[], redoStack=[], selected=null;
  let timeline=[], recordingTimeline=false, replaying=false, replayIdx=0;

  const Pal = {
    awakening:   { base:'#9bd0ff', accent:'#7fb1ff', core:'#cfe6ff', hue:205, tones:[220,440,660] },
    transformation:{ base:'#bca3ff', accent:'#9a7dff', core:'#e7ddff', hue:270, tones:[196,392,588] },
    realization: { base:'#ffd97a', accent:'#ffbe5e', core:'#fff0c8', hue:48,  tones:[174,348,522] },
    shadow:      { base:'#8da0b3', accent:'#6f8398', core:'#c5d2df', hue:210, tones:[110,220,330] }
  };

  const GLYPHS = [
    "M0,0 L10,-20 L20,0","M0,-20 L0,10 M-10,0 L10,0","M0,-20 L0,10 M0,-6 L12,-16",
    "M-10,-10 L10,-10 M0,-20 L0,5","M-8,-20 L0,-5 L8,-20 M0,-5 L0,8","M-8,-10 L8,-10 M-4,0 L4,0",
    "M0,-20 C 10,-10, 10,0, 0,10 C -10,0, -10,-10, 0,-20","M-8,-18 L8,0 M8,-18 L-8,0",
    "M0,-20 L0,8 M-10,-6 L10,-6","M-10,-20 L10,0 M10,-20 L-10,0"
  ];

  function el(tag, attrs){ const n=document.createElementNS('http://www.w3.org/2000/svg',tag); for(const k in attrs){ n.setAttribute(k,attrs[k]); } return n; }
  function hsl(h,s,l){ return `hsl(${h} ${s}% ${l}%)`; }
  function rand(a,b){ return a + Math.random()*(b-a); }

  // Sigil core state
  let runeNodes=[], links=[], seed=Math.floor(Math.random()*1e9);
  function sRand(){ seed=(1664525*seed+1013904223)%0xffffffff; return seed/0xffffffff; }

  function setChapter(name){
    chapter=name;
    chapterBtns.forEach(b=> b.classList.toggle('active', b.dataset.chapter===name));
    const pal=Pal[chapter];
    tri.setAttribute('stroke', pal.core);
    coreBg.setAttribute('opacity', centerGlow? '.14':'0');
    document.documentElement.style.setProperty('--accent', pal.accent);
    document.documentElement.style.setProperty('--ink', pal.base);
    if(audioOn) tuneAmbient();
    logEvent({type:'chapter',chapter});
  }
  chapterBtns.forEach(b=> b.addEventListener('click', ()=>setChapter(b.dataset.chapter)));
  setChapter('awakening');

  function clearSigil(){ runeNodes=[]; links=[]; gRunes.innerHTML=''; gLinks.innerHTML=''; }

  function makeSigil(count, entropy, smooth=false){
    const pal=Pal[chapter];
    const tempRunes=el('g',{}), tempLinks=el('g',{});
    const rings=[
      {r:330, n:Math.round(count*0.45), wobble:10, width:5},
      {r:245, n:Math.round(count*0.33), wobble:14, width:6},
      {r:165, n:Math.round(count*0.22), wobble:18, width:7},
    ];
    let idx=0; const newNodes=[];
    rings.forEach((ring,ri)=>{
      for(let i=0;i<ring.n;i++){
        const a=(i/ring.n)*Math.PI*2 - Math.PI/2 + (sRand()-0.5)*entropy*0.004;
        const rr=ring.r + (sRand()-0.5)*entropy*0.6;
        const x=CX+Math.cos(a)*rr, y=CY+Math.sin(a)*rr;
        const g=el('g',{transform:`translate(${x},${y}) rotate(${a*180/Math.PI+90})`});
        const p=el('path',{d:GLYPHS[(idx+ri*3)%GLYPHS.length], stroke:pal.base, 'stroke-width':ring.width, filter:'url(#soft)'});
        g.appendChild(p); tempRunes.appendChild(g);
        newNodes.push({g,p,a,ring,idx}); idx++;
      }
    });
    function linkLocal(i,j){
      if(i===j) return;
      const n1=newNodes[i], n2=newNodes[j];
      const b1=n1.g.getCTM(), b2=n2.g.getCTM();
      const p1={x:b1.e,y:b1.f}, p2={x:b2.e,y:b2.f};
      const mid={x:(p1.x+p2.x)/2, y:(p1.y+p2.y)/2 + (Math.random()*60-30)};
      const path=el('path',{d:`M ${p1.x},${p1.y} Q ${mid.x},${mid.y} ${p2.x},${p2.y}`, stroke:pal.accent, fill:'none','stroke-width':2, opacity:.25});
      tempLinks.appendChild(path);
      links.push({path,p1,p2,mid,life:0.8+Math.random()*1.8});
    }
    for(let k=0;k<Math.max(10,Math.round(count*0.6));k++){ linkLocal(Math.floor(sRand()*newNodes.length), Math.floor(sRand()*newNodes.length)); }

    if(!smooth){ clearSigil(); gRunes.append(...tempRunes.childNodes); gLinks.append(...tempLinks.childNodes); runeNodes=newNodes; return; }

    const oldRunes=gRunes.cloneNode(true), oldLinks=gLinks.cloneNode(true);
    gRunes.innerHTML=''; gLinks.innerHTML='';
    const groupOld=el('g',{opacity:'1'}), groupNew=el('g',{opacity:'0'});
    const linksOld=el('g',{opacity:'1'}), linksNew=el('g',{opacity:'0'});
    groupOld.append(...oldRunes.childNodes); groupNew.append(...tempRunes.childNodes);
    linksOld.append(...oldLinks.childNodes); linksNew.append(...tempLinks.childNodes);
    gRunes.append(groupOld, groupNew); gLinks.append(linksOld, linksNew);
    const start=performance.now(), DUR=900;
    function fade(now){
      const t=Math.min(1,(now-start)/DUR);
      groupOld.setAttribute('opacity', String(1-t)); linksOld.setAttribute('opacity', String(1-t));
      groupNew.setAttribute('opacity', String(t)); linksNew.setAttribute('opacity', String(t*0.8));
      if(t<1) requestAnimationFrame(fade);
      else{ gRunes.innerHTML=''; gLinks.innerHTML=''; gRunes.append(...groupNew.childNodes); gLinks.append(...linksNew.childNodes); runeNodes=newNodes; }
    }
    requestAnimationFrame(fade);
  }

  function generate(smooth=false){ seed=Math.floor(Math.random()*1e9); makeSigil(parseInt(runeCountEl.value,10), parseInt(entropyEl.value,10), smooth); logEvent({type:'generate'}); if(audioOn) pingChime(0.2); }
  function mutateFromSeed(smooth=true){ seed=(seed + Math.floor(Math.random()*100000+1))%0xffffffff; makeSigil(parseInt(runeCountEl.value,10), parseInt(entropyEl.value,10), smooth); logEvent({type:'mutate'}); if(audioOn) pingChime(0.15); }

  newSigilBtn.addEventListener('click', ()=>generate(true));

  // Saved entries
  function saveEntry(){
    const entry={ id:'codex-'+Date.now(), chapter, seed, count:parseInt(runeCountEl.value,10), entropy:parseInt(entropyEl.value,10), speed:parseInt(speedEl.value,10), brush:brushStack };
    const all=JSON.parse(localStorage.getItem('codexEntries')||'[]'); all.unshift(entry);
    localStorage.setItem('codexEntries', JSON.stringify(all)); renderEntries();
  }
  function renderEntries(){
    const all=JSON.parse(localStorage.getItem('codexEntries')||'[]'); entriesList.innerHTML='';
    all.forEach(e=>{
      const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='1fr auto auto'; row.style.gap='6px'; row.style.alignItems='center'; row.style.padding='6px'; row.style.border='1px solid #223142'; row.style.borderRadius='10px'; row.style.background='#0f1721';
      const label=document.createElement('div'); label.textContent=`${new Date(parseInt(e.id.split('-')[1],10)).toLocaleString()} • ${e.chapter}`; label.style.fontSize='12px'; label.style.color='#bcd0e6';
      const loadBtn=document.createElement('button'); loadBtn.className='btn'; loadBtn.textContent='Load';
      loadBtn.onclick=()=>{ chapter=e.chapter; setChapter(chapter); seed=e.seed; runeCountEl.value=e.count; entropyEl.value=e.entropy; speedEl.value=e.speed; makeSigil(e.count,e.entropy,true); brushStack=e.brush||[]; redrawBrush(); };
      const delBtn=document.createElement('button'); delBtn.className='btn'; delBtn.textContent='Delete';
      delBtn.onclick=()=>{ const rest=all.filter(x=>x.id!==e.id); localStorage.setItem('codexEntries', JSON.stringify(rest)); renderEntries(); };
      row.append(label,loadBtn,delBtn); entriesList.appendChild(row);
    });
  }
  renderEntries(); saveBtn.addEventListener('click', saveEntry);

  // Play/pause and toggles
  playPauseBtn.addEventListener('click', ()=>{ playing=!playing; playPauseBtn.textContent=playing?'Pause':'Play'; logEvent({type:'play',playing}); });
  linksToggleBtn.addEventListener('click', ()=>{ showLinks=!showLinks; gLinks.style.display=showLinks?'block':'none'; logEvent({type:'links',showLinks}); });
  centerGlowBtn.addEventListener('click', ()=>{ centerGlow=!centerGlow; coreBg.setAttribute('opacity', centerGlow?'.14':'0'); logEvent({type:'glow',centerGlow}); });

  // Export PNG
  exportBtn.addEventListener('click', ()=>{
    const xml=new XMLSerializer().serializeToString(svg); const svg64='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(xml);
    const img=new Image(); img.onload=()=>{ const c=document.createElement('canvas'); c.width=2000; c.height=2000; const ctx=c.getContext('2d'); ctx.fillStyle='#0b0f14'; ctx.fillRect(0,0,c.width,c.height); ctx.drawImage(img,0,0,c.width,c.height); const url=c.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download='tome_phase_iii.png'; a.click(); };
    img.src=svg64;
  });

  // Auto-Compose
  function scheduleNextCompose(ms){ nextComposeAt=performance.now()+ms; }
  autoToggleBtn.addEventListener('click', ()=>{ autoCompose=!autoCompose; autoToggleBtn.textContent=autoCompose?'Stop':'Start'; if(autoCompose) scheduleNextCompose(4000+Math.random()*6000); logEvent({type:'auto',autoCompose}); });
  autoNowBtn.addEventListener('click', ()=>{ autoCompose=true; autoToggleBtn.textContent='Stop'; mutateFromSeed(true); scheduleNextCompose(4000+Math.random()*6000); });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if(e.target && (e.target.tagName==='INPUT' || e.target.tagName==='TEXTAREA')) return;
    if(e.ctrlKey && e.key.toLowerCase()==='z'){ e.preventDefault(); undo(); return; }
    if(e.ctrlKey && e.key.toLowerCase()==='y'){ e.preventDefault(); redo(); return; }
    if(e.ctrlKey && e.key.toLowerCase()==='s'){ e.preventDefault(); saveEntry(); return; }

    if(e.code==='Space'){ e.preventDefault(); playPauseBtn.click(); }
    else if(e.key==='l'||e.key==='L'){ linksToggleBtn.click(); }
    else if(e.key==='g'||e.key==='G'){ centerGlowBtn.click(); }
    else if(e.key==='n'||e.key==='N'){ generate(true); }
    else if(e.key==='s'||e.key==='S'){ saveBtn.click(); }
    else if(e.key==='1'){ chapterBtns[0].click(); }
    else if(e.key==='2'){ chapterBtns[1].click(); }
    else if(e.key==='3'){ chapterBtns[2].click(); }
    else if(e.key==='4'){ chapterBtns[3].click(); }
  });

  // Web Audio
  function initAudio(){
    if(audioOn) return;
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    masterGain=audioCtx.createGain(); masterGain.gain.value=0.0; masterGain.connect(audioCtx.destination);
    ambient=makeAmbient(); chime=makeChime();
    masterGain.gain.linearRampToValueAtTime(0.25, audioCtx.currentTime+1.0);
    audioOn=true;
  }
  function stopAudio(){ if(!audioOn) return; masterGain.gain.linearRampToValueAtTime(0.0, audioCtx.currentTime+0.5); setTimeout(()=>{ audioCtx.close(); audioOn=false; audioCtx=null; },700); }
  function tuneAmbient(){ if(!audioOn) return; const tones=Pal[chapter].tones; ambient.o1.frequency.setValueAtTime(tones[0], audioCtx.currentTime); ambient.o2.frequency.setValueAtTime(tones[1], audioCtx.currentTime); ambient.o3.frequency.setValueAtTime(tones[2], audioCtx.currentTime); }
  function makeAmbient(){
    const tones=Pal[chapter].tones; const g=audioCtx.createGain(); g.gain.value=0.05; g.connect(masterGain);
    const o1=audioCtx.createOscillator(); o1.type='sine'; o1.frequency.value=tones[0];
    const o2=audioCtx.createOscillator(); o2.type='triangle'; o2.frequency.value=tones[1];
    const o3=audioCtx.createOscillator(); o3.type='sine'; o3.frequency.value=tones[2];
    const lfo=audioCtx.createOscillator(); lfo.type='sine'; lfo.frequency.value=0.08; const lfoGain=audioCtx.createGain(); lfoGain.gain.value=0.02; lfo.connect(lfoGain).connect(g.gain);
    o1.connect(g); o2.connect(g); o3.connect(g); o1.start(); o2.start(); o3.start(); lfo.start(); return {g,o1,o2,o3,lfo,lfoGain};
  }
  function makeChime(){ const g=audioCtx.createGain(); g.gain.value=0.0; g.connect(masterGain); const o=audioCtx.createOscillator(); o.type='sine'; o.frequency.value=880; const f=audioCtx.createBiquadFilter(); f.type='bandpass'; f.frequency.value=1200; f.Q.value=10; o.connect(f).connect(g); o.start(); return {g,o,f}; }
  function pingChime(strength=0.2){ if(!audioOn) return; const now=audioCtx.currentTime; chime.g.gain.cancelScheduledValues(now); chime.g.gain.setValueAtTime(0.0, now); chime.g.gain.linearRampToValueAtTime(strength, now+0.01); chime.g.gain.exponentialRampToValueAtTime(0.0001, now+0.6); chime.o.frequency.setValueAtTime(660+Math.random()*480, now); }
  soundToggleBtn.addEventListener('click', ()=>{ if(!audioOn){ initAudio(); soundToggleBtn.textContent='Sound: On'; } else { stopAudio(); soundToggleBtn.textContent='Sound: Off'; } });

  // MIDI
  midiBtn.addEventListener('click', async()=>{
    if(!navigator.requestMIDIAccess){ alert('Web MIDI not supported in this browser.'); return; }
    try{
      const access=await navigator.requestMIDIAccess();
      access.inputs.forEach(i=> i.onmidimessage = (m)=>{
        const [status, note, velocity] = m.data;
        // Note-on messages: 0x90 to 0x9F
        if((status & 0xF0) === 0x90 && velocity>0){
          const v = velocity / 127;
          midiEnabled=true;
          pulseBoost = Math.min(1, pulseBoost + v*0.6);
          if(audioOn) pingChime(0.1+0.3*v);
          logEvent({type:'midi', note, velocity});
        }
      });
      midiBtn.textContent='MIDI: On';
    }catch(e){ alert('MIDI error: '+e); }
  });

  // Microphone
  let micSource=null;
  micBtn.addEventListener('click', async()=>{
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){ alert('Microphone API not supported.'); return; }
    try{
      const stream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
      if(!audioOn){ initAudio(); soundToggleBtn.textContent='Sound: On'; }
      micSource = audioCtx.createMediaStreamSource(stream);
      micAnalyser = audioCtx.createAnalyser(); micAnalyser.fftSize = 2048;
      micData = new Uint8Array(micAnalyser.frequencyBinCount);
      micSource.connect(micAnalyser);
      micEnabled=true; micBtn.textContent='Mic: On';
      logEvent({type:'mic_on'});
    }catch(e){ alert('Mic error: '+e); }
  });

  // Runic Brush
  function screenToSVG(x,y){
    const pt=svg.createSVGPoint(); pt.x=x; pt.y=y; return pt.matrixTransform(svg.getScreenCTM().inverse());
  }
  function drawRuneAt(px,py, rot=0, sc=1, glyphIndex=null){
    const pal=Pal[chapter];
    const d=GLYPHS[glyphIndex==null ? Math.floor(Math.random()*GLYPHS.length) : glyphIndex];
    const g=el('g',{transform:`translate(${px},${py}) rotate(${rot}) scale(${sc})`});
    const p=el('path',{d, stroke:pal.base, 'stroke-width':6*sc, filter:'url(#soft)'});
    g.appendChild(p); gBrush.appendChild(g);
    return {g,p,px,py,rot,sc,glyphIndex:d};
  }
  function redrawBrush(){
    gBrush.innerHTML='';
    brushStack.forEach(b=>{
      const g=el('g',{transform:`translate(${b.px},${b.py}) rotate(${b.rot}) scale(${b.sc})`});
      const p=el('path',{d:b.glyphIndex, stroke:Pal[chapter].base, 'stroke-width':6*b.sc, filter:'url(#soft)'});
      g.appendChild(p); gBrush.appendChild(g);
      b._g=g; b._p=p;
    });
  }
  function undo(){ if(!brushStack.length) return; redoStack.push(brushStack.pop()); redrawBrush(); }
  function redo(){ if(!redoStack.length) return; brushStack.push(redoStack.pop()); redrawBrush(); }
  let brushDown=false, lastPos=null;
  createToggleBtn.addEventListener('click', ()=>{ createMode=!createMode; createToggleBtn.textContent = createMode? 'Create: On' : 'Create: Off'; tooltip.style.display=createMode?'block':'none'; });
  undoBtn.addEventListener('click', undo); redoBtn.addEventListener('click', redo);
  rotateBtn.addEventListener('click', ()=>{ if(!brushStack.length) return; brushStack[brushStack.length-1].rot += 22.5; redrawBrush(); });
  scaleBtn.addEventListener('click', ()=>{ if(!brushStack.length) return; brushStack[brushStack.length-1].sc *= 1.1; redrawBrush(); });
  fuseBtn.addEventListener('click', ()=>{ /* placeholder: future boolean ops */ alert('Fuse: placeholder (visual merge planned).'); });

  function onPointerMove(e){
    const r=svg.getBoundingClientRect(); const x=e.clientX, y=e.clientY;
    tooltip.style.left = (x+12)+'px'; tooltip.style.top = (y+12)+'px';
    if(createMode && brushDown){
      const pt=screenToSVG(x,y);
      const dx=!lastPos?0:(pt.x-lastPos.x), dy=!lastPos?0:(pt.y-lastPos.y);
      const dist=Math.hypot(dx,dy);
      if(dist>18){
        const ang=Math.atan2(dy,dx)*180/Math.PI;
        const sc=0.9+Math.random()*0.4;
        const rune=drawRuneAt(pt.x, pt.y, ang, sc, null);
        brushStack.push({px:pt.x, py:pt.y, rot:ang, sc, glyphIndex:rune.glyphIndex});
        lastPos=pt;
      }
    }
  }
  function onPointerDown(e){
    if(!createMode) return;
    brushDown=true;
    const pt=screenToSVG(e.clientX, e.clientY);
    lastPos=pt;
    const ang=Math.random()*360, sc=0.9+Math.random()*0.4;
    const rune=drawRuneAt(pt.x, pt.y, ang, sc, null);
    brushStack.push({px:pt.x, py:pt.y, rot:ang, sc, glyphIndex:rune.glyphIndex});
  }
  function onPointerUp(){ brushDown=false; lastPos=null; }
  svg.addEventListener('pointermove', onPointerMove);
  svg.addEventListener('pointerdown', onPointerDown);
  window.addEventListener('pointerup', onPointerUp);

  // Timeline
  function logEvent(ev){
    if(!recordingTimeline) return;
    ev.t = performance.now();
    timeline.push(ev);
    timelineInfo.textContent = 'Frames: ' + timeline.length;
  }
  recToggle.addEventListener('click', ()=>{ recordingTimeline=!recordingTimeline; recToggle.textContent=recordingTimeline?'Stop Recording':'Record Session'; if(recordingTimeline){ timeline=[]; timelineInfo.textContent='Frames: 0'; } });
  clearLog.addEventListener('click', ()=>{ timeline=[]; timelineInfo.textContent='Frames: 0'; });
  replayBtn.addEventListener('click', ()=>{
    if(!timeline.length){ alert('No timeline recorded.'); return; }
    replaying=true; replayIdx=0;
    const start=timeline[0].t;
    function step(){
      if(replayIdx>=timeline.length){ replaying=false; return; }
      const ev=timeline[replayIdx];
      const delay = (ev.t - (replayIdx? timeline[replayIdx-1].t : start)) / 1.0;
      setTimeout(()=>{
        // basic event reconstruction
        if(ev.type==='chapter') setChapter(ev.chapter);
        else if(ev.type==='generate') generate(true);
        else if(ev.type==='mutate') mutateFromSeed(true);
        else if(ev.type==='links') { showLinks=ev.showLinks; gLinks.style.display=showLinks?'block':'none'; }
        else if(ev.type==='glow') { centerGlow=ev.centerGlow; coreBg.setAttribute('opacity', centerGlow?'.14':'0'); }
        else if(ev.type==='play') { playing=ev.playing; playPauseBtn.textContent=playing?'Pause':'Play'; }
        replayIdx++; step();
      }, Math.max(10, delay));
    }
    step();
  });

  // WebM Recording of the canvas (SVG + overlay)
  function createCaptureStream(){
    // Draw SVG and overlay to an offscreen canvas for capture
    const c=document.createElement('canvas'); c.width=1000; c.height=1000;
    const ctx=c.getContext('2d');
    function drawFrame(){
      const xml=new XMLSerializer().serializeToString(svg);
      const img=new Image();
      img.onload=()=>{
        ctx.fillStyle='#0b0f14'; ctx.fillRect(0,0,1000,1000);
        ctx.drawImage(img,0,0,1000,1000);
        // overlay brushLayer (raster)
        const bctx=brushLayer.getContext('2d');
        if(bctx){ ctx.drawImage(brushLayer, 0,0,1000,1000); }
      };
      img.src='data:image/svg+xml;charset=utf-8,' + encodeURIComponent(xml);
      requestAnimationFrame(drawFrame);
    }
    requestAnimationFrame(drawFrame);
    return c.captureStream(30);
  }
  recordBtn.addEventListener('click', ()=>{
    if(recording){ recorder.stop(); return; }
    const stream=createCaptureStream();
    recorder=new MediaRecorder(stream, {mimeType:'video/webm;codecs=vp9'});
    recordChunks=[];
    recorder.ondataavailable=(e)=>{ if(e.data.size>0) recordChunks.push(e.data); };
    recorder.onstop=()=>{
      const blob=new Blob(recordChunks,{type:'video/webm'});
      const url=URL.createObjectURL(blob);
      downloadLink.href=url; downloadLink.style.display='inline-block';
    };
    recorder.start(); recording=true; recordBtn.textContent='Stop Recording';
    setTimeout(()=>{ recording=false; recordBtn.textContent='Record WebM'; recorder.stop(); }, 15000); // auto-stop after 15s
  });

  // Animation
  let t0=performance.now(); let pulseBoost=0;
  function tick(now){
    // Auto compose
    if(autoCompose && now>=nextComposeAt){ mutateFromSeed(true); scheduleNextCompose(4000+Math.random()*6000); }

    if(playing){
      const t=(now-t0)/1000;
      const pal=Pal[chapter]; const hue=pal.hue;
      const col=hsl(hue,90,70); const col2=hsl((hue+15)%360,95,75);

      // Mic amplitude to boost
      if(micEnabled && micAnalyser){
        micAnalyser.getByteTimeDomainData(micData);
        // RMS estimate
        let sum=0; for(let i=0;i<micData.length;i++){ const v=(micData[i]-128)/128; sum+=v*v; }
        const rms=Math.sqrt(sum/micData.length);
        pulseBoost = Math.min(1, Math.max(pulseBoost, rms*2.2));
      }

      runeNodes.forEach((n,idx)=>{
        const sp=(parseInt(speedEl.value,10)/80);
        const basePulse=Math.max(0, Math.sin(t*1.6*sp + idx*0.7));
        const pulse = 0.35 + 0.65*(0.7*basePulse + 0.3*pulseBoost);
        n.p.setAttribute('stroke', col);
        n.p.setAttribute('stroke-width', n.ring.width * (0.8 + 0.4*pulse));
        const wob=n.ring.wobble*(Math.sin(t*0.7*sp + idx)*0.5) * (1+0.6*pulseBoost);
        n.g.setAttribute('transform', `translate(${CX + Math.cos(n.a)*(n.ring.r + wob)}, ${CY + Math.sin(n.a)*(n.ring.r + wob)}) rotate(${n.a*180/Math.PI+90})`);
        if(audioOn && basePulse>0.97 && Math.random()<0.02){ pingChime(0.08+0.15*pulseBoost); }
      });

      // Links
      const Ls=[...gLinks.children];
      for(let i=Ls.length-1;i>=0;i--){
        const path=Ls[i];
        const life=parseFloat(path.getAttribute('data-life')|| (0.8+Math.random()*1.8));
        const newLife=life - 0.016*(parseInt(speedEl.value,10)/60)*(1+0.8*pulseBoost);
        path.setAttribute('data-life', newLife);
        path.setAttribute('stroke', col2);
        path.setAttribute('opacity', Math.max(0, Math.min(0.9, newLife)));
        if(newLife<=0){ gLinks.removeChild(path);
          if(showLinks && runeNodes.length>1){
            const a=Math.floor(Math.random()*runeNodes.length), b=Math.floor(Math.random()*runeNodes.length);
            if(a!==b){
              const n1=runeNodes[a], n2=runeNodes[b];
              const b1=n1.g.getCTM(), b2=n2.g.getCTM();
              const p1={x:b1.e,y:b1.f}, p2={x:b2.e,y:b2.f};
              const mid={x:(p1.x+p2.x)/2, y:(p1.y+p2.y)/2 + (Math.random()*60-30)};
              const newP=el('path',{d:`M ${p1.x},${p1.y} Q ${mid.x},${mid.y} ${p2.x},${p2.y}`, stroke:col2, fill:'none','stroke-width':2, opacity:.25});
              newP.setAttribute('data-life', 0.8+Math.random()*1.8);
              gLinks.appendChild(newP);
            }
          }
        }
      }

      // tri
      const s=1+0.03*Math.sin(t*2.0*(parseInt(speedEl.value,10)/80))*(1+0.4*pulseBoost);
      tri.setAttribute('transform', `translate(${CX},${CY}) scale(${s}) translate(${-CX},${-CY})`);

      // decay pulse boost
      pulseBoost *= 0.95;
    }

    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  // Initial render
  generate(false);

})();</script>
</body>
</html>
